####################################
#data_wd        <-  "C:/Users/xd-br/Dropbox/causal_schools"
#code_output_wd <-  "C:/Users/xd-br/Desktop/PhD/Research/causal_schools"

data_wd <- "C:/Users/brunem/Dropbox/causal_schools"
code_output_wd <-  "C:/Users/brunem/Research/causal_schools"

#Datawd (Dropbox) 
setwd(data_wd)
#####################################

library(tidyverse)

load("./data/clean/samples.RData")
load("./data/clean/treatment_1R.RData")
load("./data/clean/stem_outcome.RData")

#Academic controls and school of graduation, only for first year applying
load("./data/clean/psu_students.RData")
load("./data/clean/sae_2017_19_stud_controls.RData")
load("./data/clean/tracking_clean_wide.RData")

rm(students_apps_demre)


final_data <-   sample_students %>%
  rename(rbd_target = rbd) %>% 
  left_join(sae_stud_info, by = c("mrun", "proceso")) %>%
  left_join(tracking_window_wide, by = c("mrun", "proceso", "rbd_target")) %>%
    left_join(all_treatments, by = c("br_code", "mrun"))  %>%
  left_join(students_apps, by = "mrun") %>%
  rename(grad_rbd_psu = RBD) %>% 
  mutate(female = as.integer(ifelse(es_mujer == 0, 0, 1))) %>% 
  mutate(male   = as.integer(ifelse(es_mujer == 0, 1, 0))) %>% 
  mutate(gender = as.integer(ifelse(es_mujer == 0, "Male", "Female"))) %>% 
  mutate(took_science = as.factor(ifelse(scien_max == 0, "No", "Yes")),
         gender_science = factor(paste(gender, took_science, sep = "_"))
         ) %>%
  mutate(took_history = as.factor(ifelse(hist_max == 0, "No", "Yes"))) %>% 
  mutate(took_both = as.factor(ifelse(hist_max > 0 & scien_max > 0  , "Yes", "No"))) %>% 
    mutate(leng_math_total = math_max + leng_max) %>% 
  mutate(graduated_hs   = as.integer(ifelse(!(is.na(PROM_NOTAS)), 1, 0))) %>% 
  mutate(registered_psu = as.integer(ifelse(!(is.na(FECHA_NACIMIENTO)), 1, 0))) %>% 
  mutate(completed_psu = as.integer(ifelse(leng_math_total> 0,  1, 0))) %>% 
  #   left_join(socioecon_controls,   by = "mrun")  %>%
  left_join(stem_outcome,   by = "mrun")  %>%
  mutate(graduated_from_applied_school = (grad_rbd_psu == rbd_target)) %>% 
  mutate(rbd_admitido = factor(rbd_admitido)) 



#final_data %>% 
#  filter(completed_psu == 1) %>% 
#  filter(registered_psu == 0) %>% 
#  filter(is.na(RBD)) %>% 
#  View()

save(final_data,  file = "./data/clean/final_data.Rdata")

haven::write_dta(final_data, path = "./data/clean/final_data.dta")


